name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Install Qt (MinGW 8.1.0)
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw81'
        install-deps: 'true'
        tools: 'tools_mingw,qt.tools.win64_mingw810'

    # 2. Build & Package
    - name: Build and Package
      working-directory: .
      shell: bash
      run: |
        # --- SETUP PATHS ---
        # The Qt Action sets 'Qt5_Dir', we use it to find bins and plugins
        export QT_ROOT="${Qt5_Dir}"
        export QT_BIN="${QT_ROOT}/bin"
        export QT_PLUGINS="${QT_ROOT}/plugins"
        export MINGW_BIN="${IQTA_TOOLS}/mingw810_64/bin"
        
        # Add MinGW and Qt Bin to PATH so CMake and Windeployqt work
        export PATH="$MINGW_BIN:$QT_BIN:$PATH"
        
        # CRITICAL FIX: Tell windeployqt where the plugins are
        export QT_PLUGIN_PATH="$QT_PLUGINS"

        echo "Qt Root: $QT_ROOT"
        echo "Plugin Path: $QT_PLUGIN_PATH"

        # --- BUILD ---
        mkdir build && cd build
        
        # Force MinGW Generator and Compiler
        cmake .. -G "MinGW Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER="gcc.exe" \
          -DCMAKE_CXX_COMPILER="g++.exe"
          
        cmake --build . --config Release
        
        # --- DEPLOY ---
        echo "Running windeployqt..."
        # --dir . tells it to dump dlls right here
        windeployqt --release --no-translations --no-compiler-runtime --dir . NoveoDesktop.exe
        
        # --- MANUAL COPY (MinGW System DLLs) ---
        echo "Copying MinGW Runtime DLLs..."
        cp "$MINGW_BIN/libgcc_s_seh-1.dll" .
        cp "$MINGW_BIN/libstdc++-6.dll" .
        cp "$MINGW_BIN/libwinpthread-1.dll" .
        
        # --- ZIP ---
        echo "Zipping..."
        7z a NoveoDesktop-Windows.zip * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

    # 3. Upload to Release
    - name: Upload Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: build/NoveoDesktop-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
