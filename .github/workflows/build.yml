name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  version-bump:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.tag.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump version and create tag
        id: tag
        run: |
          latest=$(git tag -l "v*" --sort=-v:refname | head -n 1)
          if [ -z "$latest" ]; then
            new="v1.0.0"
          else
            base=${latest#v}
            major=${base%%.*}
            rest=${base#*.}
            minor=${rest%%.*}
            patch=${rest##*.}
            patch=$((patch + 1))
            new="v$major.$minor.$patch"
          fi
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag "$new"
          git push origin "$new"
          echo "new_version=$new" >> $GITHUB_OUTPUT

  build-windows:
    needs: version-bump
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Build and Package
        shell: bash
        run: |
          export QT_ROOT="$Qt5_Dir"
          export MINGW_BIN="$IQTA_TOOLS/mingw810_64/bin"
          export PATH="$MINGW_BIN:$QT_ROOT/bin:$PATH"

          mkdir build && cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build .

          echo "Running windeployqt..."
          "$QT_ROOT/bin/windeployqt.exe" --release --no-translations --no-compiler-runtime --dir . ./NoveoDesktop.exe || true

          cp "$MINGW_BIN/libgcc_s_seh-1.dll" .
          cp "$MINGW_BIN/libstdc++-6.dll" .
          cp "$MINGW_BIN/libwinpthread-1.dll" .

          ZIP_NAME="NoveoDesktop-${{ needs.version-bump.outputs.new_version }}.zip"
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

      - name: Upload Release ZIP
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version-bump.outputs.new_version }}
          name: "NoveoDesktop Windows Release - ${{ needs.version-bump.outputs.new_version }}"
          files: build/NoveoDesktop-${{ needs.version-bump.outputs.new_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: NoveoDesktop-Windows
          path: build/NoveoDesktop-${{ needs.version-bump.outputs.new_version }}.zip
