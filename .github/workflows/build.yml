name: Build Desktop Release (Win/Lin/Mac)

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # =========================================================
  # PREPARE: CALCULATE VERSION & DATE
  # =========================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.setver.outputs.new_version }}
      build_date: ${{ steps.date.outputs.date }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine or bump tag
        id: setver
        env:
          REPO: ${{ github.repository }}
          # Optional: set a secret REPO_PAT for reliable push permissions (preferred).
          REPO_PAT: ${{ secrets.REPO_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            latest=$(git tag -l "v*" --sort=-v:refname | head -n 1)
            if [ -z "$latest" ]; then
              new="v1.0.0"
            else
              base=${latest#v}
              major=${base%%.*}
              rest=${base#*.}
              minor=${rest%%.*}
              patch=${rest##*.}

              patch=$((patch + 1))
              if [ "$patch" -gt 15 ]; then
                patch=0
                minor=$((minor + 1))
              fi
              if [ "$minor" -gt 99 ]; then
                minor=0
                major=$((major + 1))
              fi
              new="v$major.$minor.$patch"
            fi
            echo "Manual dispatch -> new tag: $new"
            
            if [ -n "$REPO_PAT" ]; then
              AUTH_TOKEN="$REPO_PAT"
            else
              AUTH_TOKEN="$GITHUB_TOKEN"
            fi
            
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git remote set-url origin https://${AUTH_TOKEN}@github.com/${REPO}.git
            git tag "$new"
            git push origin "$new"
            echo "new_version=$new" >> $GITHUB_OUTPUT
          else
            refname=${GITHUB_REF##*/}
            echo "Release event -> using tag: $refname"
            echo "new_version=$refname" >> $GITHUB_OUTPUT
          fi

  # =========================================================
  # WINDOWS BUILD
  # =========================================================
  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Build and Package
        shell: bash
        env:
          QT_ROOT: ${{ env.Qt5_Dir }}
          MINGW_BIN: ${{ env.IQTA_TOOLS }}/mingw810_64/bin
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e
          
          # 1. Update version.rc
          # Convert v1.1.8 -> 1,1,8,0 and 1.1.8.0
          VER_NO_V=${VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VER_NO_V"
          RC_NUM="${MAJOR},${MINOR},${PATCH},0"
          RC_STR="${MAJOR}.${MINOR}.${PATCH}.0"

          echo "Updating version.rc to $RC_STR..."
          # If version.rc is in a subdir, adjust path here (e.g. src/version.rc)
          RC_FILE="version.rc"
          if [ -f "$RC_FILE" ]; then
            sed -i -E "s/FILEVERSION[ \t]+[0-9,]+/FILEVERSION     ${RC_NUM}/" "$RC_FILE"
            sed -i -E "s/PRODUCTVERSION[ \t]+[0-9,]+/PRODUCTVERSION  ${RC_NUM}/" "$RC_FILE"
            sed -i -E "s/(\"FileVersion\",[ \t]*\")[0-9.]+(\".*)/\1${RC_STR}\2/" "$RC_FILE"
            sed -i -E "s/(\"ProductVersion\",[ \t]*\")[0-9.]+(\".*)/\1${RC_STR}\2/" "$RC_FILE"
          else
            echo "WARNING: version.rc not found, skipping version update."
          fi

          # 2. Configure Environment
          export QT_ROOT="${Qt5_Dir}"
          export MINGW_BIN="${IQTA_TOOLS}/mingw810_64/bin"
          export PATH="$MINGW_BIN:$QT_ROOT/bin:$PATH"
          export QT_PLUGIN_PATH="${QT_ROOT}/plugins"

          mkdir -p build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

          # 3. Deploy Qt DLLs
          "$QT_ROOT/bin/windeployqt.exe" --release --no-translations --no-compiler-runtime --dir . ./NoveoDesktop.exe || true

          # 4. Download OpenSSL
          echo "Downloading OpenSSL..."
          curl -L -o libssl-1_1-x64.dll http://hienob.bargmy.ir/openssl/libssl-1_1-x64.dll
          curl -L -o libcrypto-1_1-x64.dll http://hienob.bargmy.ir/openssl/libcrypto-1_1-x64.dll
          
          # 5. MinGW Runtimes
          cp "$MINGW_BIN/libgcc_s_seh-1.dll" . || true
          cp "$MINGW_BIN/libstdc++-6.dll" . || true
          cp "$MINGW_BIN/libwinpthread-1.dll" . || true

          # 6. Zip Artifact
          ZIP_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_Windows.zip"
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

          echo "WIN_ASSET=build/$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Windows Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.WIN_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =========================================================
  # LINUX BUILD (AppImage)
  # =========================================================
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          install-deps: 'true'

      - name: Install Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev cmake wget file

      - name: Build and Bundle
        env:
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e
          export PATH="${Qt5_Dir}/bin:$PATH"

          mkdir -p build
          cd build
          
          # IMPORTANT: Set Install Prefix to /usr
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . --config Release
          
          # Install to AppDir
          mkdir -p AppDir
          make install DESTDIR=AppDir

          # Get linuxdeployqt
          wget -c -nv https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

          # Create .desktop file IF MISSING in correct location
          # It MUST be in usr/share/applications/ inside AppDir
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
          
          # If you have an icon, copy it: cp ../icon.png AppDir/usr/share/icons/hicolor/256x256/apps/NoveoDesktop.png

          if [ ! -f "AppDir/usr/share/applications/NoveoDesktop.desktop" ]; then
             echo "Creating desktop file..."
             cat > AppDir/usr/share/applications/NoveoDesktop.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=NoveoDesktop
          Exec=NoveoDesktop
          Icon=NoveoDesktop
          Categories=Utility;
          EOF
          fi

          # Use a variable for the desktop file path
          DESKTOP="AppDir/usr/share/applications/NoveoDesktop.desktop"

          # Run linuxdeployqt
          # -appimage: creates the AppImage
          # -unsupported-allow-new-glibc: needed on newer runners
          ./linuxdeployqt-continuous-x86_64.AppImage "$DESKTOP" -appimage -unsupported-allow-new-glibc -no-translations

          # Rename Output
          APPIMAGE=$(ls *.AppImage | head -n 1)
          NEW_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_Ubuntu.AppImage"
          mv "$APPIMAGE" "$NEW_NAME"
          
          echo "LINUX_ASSET=build/$NEW_NAME" >> $GITHUB_ENV

      - name: Upload Linux Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.LINUX_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =========================================================
  # MACOS BUILD
  # =========================================================
  build-macos:
    needs: prepare
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          install-deps: 'true'

      - name: Build and Bundle
        env:
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e
          export PATH="${Qt5_Dir}/bin:$PATH"
          
          mkdir -p build
          cd build
          
          # FORCE x86_64 ARCHITECTURE
          # Qt 5.15.2 OSS libs are x86_64 only. macOS runner is M1 (arm64).
          # We must cross-compile for x86_64 to link successfully.
          cmake .. -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_PREFIX_PATH="${Qt5_Dir}" \
                   -DCMAKE_OSX_ARCHITECTURES=x86_64

          cmake --build . --config Release

          # Find .app
          APP_BUNDLE=$(find . -name "*.app" | head -n 1)
          if [ -z "$APP_BUNDLE" ]; then echo "Error: .app not found"; exit 1; fi

          # Bundle Frameworks
          macdeployqt "$APP_BUNDLE" -dmg

          # Prepare ZIP (optional, if you prefer zip over DMG)
          # Note: We label it x64 because it is an Intel build
          ZIP_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_MacOS.zip"
          zip -r "$ZIP_NAME" "$APP_BUNDLE"

          # Use DMG if generated
          DMG_FILE=$(ls *.dmg 2>/dev/null | head -n 1 || true)
          if [ -n "$DMG_FILE" ]; then
             NEW_DMG="NoveoDesktop_${VERSION}_${DATE}_x64_MacOS.dmg"
             mv "$DMG_FILE" "$NEW_DMG"
             FINAL_ASSET="$NEW_DMG"
          else
             FINAL_ASSET="$ZIP_NAME"
          fi

          echo "MAC_ASSET=build/$FINAL_ASSET" >> $GITHUB_ENV

      - name: Upload MacOS Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.MAC_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
