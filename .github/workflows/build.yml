name: Build Windows Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4

    # 1. Install Qt (MinGW 8.1.0)
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw81'
        install-deps: 'true'
        tools: 'tools_mingw,qt.tools.win64_mingw810'

    # 2. Build & Package
    - name: Build and Package
      working-directory: .
      shell: bash
      run: |
        # Set Paths
        export PATH="${IQTA_TOOLS}/mingw810_64/bin:$PATH"
        export PATH="${Qt5_Dir}/bin:$PATH"  # Add Qt Bin explicitly
        
        mkdir build && cd build
        
        # Configure & Build
        cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="gcc.exe" -DCMAKE_CXX_COMPILER="g++.exe"
        cmake --build . --config Release
        
        echo "Build Complete. Running Deployment..."
        
        # Deploy Qt DLLs (simplified flags)
        # We explicitly point to the qmake to ensure it finds plugins
        windeployqt --release --no-translations --no-compiler-runtime NoveoDesktop.exe
        
        # Copy MinGW Runtime DLLs
        cp "${IQTA_TOOLS}/mingw810_64/bin/libgcc_s_seh-1.dll" .
        cp "${IQTA_TOOLS}/mingw810_64/bin/libstdc++-6.dll" .
        cp "${IQTA_TOOLS}/mingw810_64/bin/libwinpthread-1.dll" .
        
        # Zip everything
        7z a NoveoDesktop-Windows.zip * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

    # 3. Upload to Release
    - name: Upload Asset
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: build/NoveoDesktop-Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
