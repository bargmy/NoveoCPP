  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt (MinGW 8.1.0)
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Build and Package
        shell: bash
        env:
          QT_ROOT: ${{ env.Qt5_Dir }}
          MINGW_BIN: ${{ env.IQTA_TOOLS }}/mingw810_64/bin
        run: |
          set -e
          export MINGW_BIN="${IQTA_TOOLS}/mingw810_64/bin"
          export PATH="$MINGW_BIN:$QT_ROOT/bin:$PATH"
          export QT_PLUGIN_PATH="${QT_ROOT}/plugins"

          mkdir -p build
          cd build

          echo "Configuring project..."
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

          echo "Running windeployqt..."
          "$QT_ROOT/bin/windeployqt.exe" --release --no-translations --no-compiler-runtime --dir . ./NoveoDesktop.exe || true

          # --- FIX: DOWNLOAD OPENSSL FROM YOUR SERVER ---
          echo "Downloading OpenSSL binaries from hienob.bargmy.ir..."
          
          # Assuming the URL returns a ZIP file containing the DLLs
          curl -L -o openssl_libs.zip http://hienob.bargmy.ir/openssl
          
          # Extract the ZIP. We use -j to flatten directories just in case they are in a subfolder.
          # We explicitly look for the required DLLs.
          unzip -j openssl_libs.zip "libssl-1_1-x64.dll" "libcrypto-1_1-x64.dll"
          
          # Verify files exist
          if [ ! -f "libssl-1_1-x64.dll" ] || [ ! -f "libcrypto-1_1-x64.dll" ]; then
             echo "ERROR: OpenSSL DLLs failed to download or extract from your server."
             echo "Please ensure http://hienob.bargmy.ir/openssl is a direct link to a ZIP file containing libssl-1_1-x64.dll and libcrypto-1_1-x64.dll"
             exit 1
          fi
          # --- FIX END ---

          # Copy MinGW runtimes
          cp "$MINGW_BIN/libgcc_s_seh-1.dll" . || true
          cp "$MINGW_BIN/libstdc++-6.dll" . || true
          cp "$MINGW_BIN/libwinpthread-1.dll" . || true

          # Create ZIP
          VERSION=${{ needs.prepare.outputs.new_version }}
          ZIP_NAME="NoveoDesktop-${VERSION}.zip"
          echo "Zipping to $ZIP_NAME..."
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: build/NoveoDesktop-${{ needs.prepare.outputs.new_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
