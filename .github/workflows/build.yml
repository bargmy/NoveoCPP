name: Build Release (Windows & Linux)

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.setver.outputs.new_version }}
      build_date: ${{ steps.date.outputs.date }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine or bump tag
        id: setver
        env:
          REPO: ${{ github.repository }}
          REPO_PAT: ${{ secrets.REPO_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            latest=$(git tag -l "v*" --sort=-v:refname | head -n 1)
            if [ -z "$latest" ]; then
              new="v1.0.0"
            else
              base=${latest#v}
              major=${base%%.*}
              rest=${base#*.}
              minor=${rest%%.*}
              patch=${rest##*.}
              patch=$((patch + 1))
              if [ "$patch" -gt 15 ]; then
                patch=0
                minor=$((minor + 1))
              fi
              if [ "$minor" -gt 99 ]; then
                minor=0
                major=$((major + 1))
              fi
              new="v$major.$minor.$patch"
            fi
            echo "New tag: $new"
            
            if [ -n "$REPO_PAT" ]; then
              AUTH_TOKEN="$REPO_PAT"
            else
              AUTH_TOKEN="$GITHUB_TOKEN"
            fi
            
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git remote set-url origin https://${AUTH_TOKEN}@github.com/${REPO}.git
            git tag "$new"
            git push origin "$new"
            echo "new_version=$new" >> $GITHUB_OUTPUT
          else
            refname=${GITHUB_REF##*/}
            echo "Release event: $refname"
            echo "new_version=$refname" >> $GITHUB_OUTPUT
          fi

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'

      - name: Build and Package
        shell: bash
        env:
          QT_ROOT: ${{ env.Qt5_Dir }}
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e
          export PATH="${{ env.IQTA_TOOLS }}/mingw810_64/bin:$QT_ROOT/bin:$PATH"
          
          mkdir -p build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

          # Deployment
          "$QT_ROOT/bin/windeployqt.exe" --release --no-translations --no-compiler-runtime --dir . ./NoveoDesktop.exe || true

          # OpenSSL
          curl -L -o libssl-1_1-x64.dll http://hienob.bargmy.ir/openssl/libssl-1_1-x64.dll
          curl -L -o libcrypto-1_1-x64.dll http://hienob.bargmy.ir/openssl/libcrypto-1_1-x64.dll

          # MinGW Runtimes
          MINGW_BIN="${{ env.IQTA_TOOLS }}/mingw810_64/bin"
          cp "$MINGW_BIN/libgcc_s_seh-1.dll" . || true
          cp "$MINGW_BIN/libstdc++-6.dll" . || true
          cp "$MINGW_BIN/libwinpthread-1.dll" . || true

          # Construct Name: NoveoDesktop_{version}_{date}_{arch}_{OS}.zip
          ZIP_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_Windows.zip"
          echo "Creating ZIP: $ZIP_NAME"
          
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

          echo "WIN_ASSET_PATH=build/$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.WIN_ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          install-deps: 'true'

      - name: Install System Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev cmake

      - name: Build
        env:
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          mkdir build
          cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release
          
          # Prepare Artifact Folder
          # Name: NoveoDesktop_{version}_{date}_{arch}_{OS}
          FOLDER_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_Ubuntu"
          mkdir "$FOLDER_NAME"
          
          # Copy executable
          cp NoveoDesktop "$FOLDER_NAME/"
          
          # Note: For a truly portable Linux build, you might need linuxdeployqt or AppImage.
          # For now, we allow the system to use installed libs or relative libs if configured.
          
          # Zip it
          zip -r "${FOLDER_NAME}.zip" "$FOLDER_NAME"
          
          echo "LINUX_ASSET_PATH=build/${FOLDER_NAME}.zip" >> $GITHUB_ENV

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.LINUX_ASSET_PATH }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
