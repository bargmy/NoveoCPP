name: Build Windows Release

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.setver.outputs.new_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: setver
        env:
          REPO: ${{ github.repository }}
          REPO_PAT: ${{ secrets.REPO_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            latest=$(git tag -l "v*" --sort=-v:refname | head -n 1)
            if [ -z "$latest" ]; then new="v1.0.0"; else
              base=${latest#v}; major=${base%%.*}; rest=${base#*.}; minor=${rest%%.*}; patch=${rest##*.}
              patch=$((patch + 1)); new="v$major.$minor.$patch"
            fi
            echo "new_version=$new" >> $GITHUB_OUTPUT
            if [ -n "$REPO_PAT" ]; then AUTH="$REPO_PAT"; else AUTH="$GITHUB_TOKEN"; fi
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git remote set-url origin https://${AUTH}@github.com/${REPO}.git
            git tag "$new"
            git push origin "$new"
          else
            echo "new_version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          fi

  build-windows:
    needs: prepare
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt (MinGW 8.1.0)
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Install OpenSSL 1.1.1 (Chocolatey)
        run: |
          # Install specific version 1.1.1.2100 (OpenSSL 1.1.1u) to avoid OpenSSL 3.x
          choco install openssl --version 1.1.1.2100 -y --no-progress

      - name: Build and Package
        shell: bash
        env:
          QT_ROOT: ${{ env.Qt5_Dir }}
          # Path to the OpenSSL we just installed
          OPENSSL_ROOT: "C:/Program Files/OpenSSL-Win64"
          MINGW_BIN: ${{ env.IQTA_TOOLS }}/mingw810_64/bin
        run: |
          set -e
          export PATH="$MINGW_BIN:$QT_ROOT/bin:$PATH"
          export QT_PLUGIN_PATH="${QT_ROOT}/plugins"

          mkdir -p build && cd build

          echo "Configuring project..."
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release

          echo "Running windeployqt..."
          "$QT_ROOT/bin/windeployqt.exe" --release --no-translations --no-compiler-runtime --dir . ./NoveoDesktop.exe || true

          # --- FIX: Copy OpenSSL DLLs from Chocolatey Install ---
          echo "Copying OpenSSL DLLs from $OPENSSL_ROOT..."
          
          # Try standard names (usually found in C:/Program Files/OpenSSL-Win64/bin)
          # Note: The '|| true' prevents build failure if names differ, subsequent checks handle errors.
          cp "$OPENSSL_ROOT/bin/libssl-1_1-x64.dll" . || cp "$OPENSSL_ROOT/bin/libssl-1_1.dll" . || true
          cp "$OPENSSL_ROOT/bin/libcrypto-1_1-x64.dll" . || cp "$OPENSSL_ROOT/bin/libcrypto-1_1.dll" . || true

          # Verify they were copied
          if [ ! -f "libssl-1_1-x64.dll" ] && [ ! -f "libssl-1_1.dll" ]; then
             echo "ERROR: OpenSSL DLLs not found in $OPENSSL_ROOT/bin"
             ls -R "$OPENSSL_ROOT"
             exit 1
          fi

          # Copy MinGW runtimes
          cp "$MINGW_BIN/libgcc_s_seh-1.dll" . || true
          cp "$MINGW_BIN/libstdc++-6.dll" . || true
          cp "$MINGW_BIN/libwinpthread-1.dll" . || true

          # Create ZIP
          VERSION=${{ needs.prepare.outputs.new_version }}
          ZIP_NAME="NoveoDesktop-${VERSION}.zip"
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          name: "Windows Release ${{ needs.prepare.outputs.new_version }}"
          files: build/NoveoDesktop-${{ needs.prepare.outputs.new_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
