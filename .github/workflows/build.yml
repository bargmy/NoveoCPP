name: Build Desktop Release (Win/Lin/Mac)

permissions:
  contents: write

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  # =========================================================
  # PREPARE: CALCULATE VERSION & DATE
  # =========================================================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.setver.outputs.new_version }}
      build_date: ${{ steps.date.outputs.date }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Determine or bump tag
        id: setver
        env:
          REPO: ${{ github.repository }}
          REPO_PAT: ${{ secrets.REPO_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ]; then
            # Find latest v*-style tag (vMAJOR.MINOR.PATCH.BUILD)
            latest=$(git tag -l "v*" --sort=-v:refname | head -n 1)

            if [ -z "$latest" ]; then
              # First tag ever
              new="v1.0.0.0"
            else
              base=${latest#v}

              # Parse up to 4 numeric components; default BUILD to 0 if missing
              IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$base"
              : "${BUILD:=0}"

              echo "Latest tag: $latest -> ${MAJOR}.${MINOR}.${PATCH}.${BUILD}"

              # Detect code changes since last tag, ignoring non-code files
              # (CMakeLists.txt, version.rc, README.md, icon.png, icon.ico)
              changed_files=$(git diff --name-only "$latest"..HEAD | grep -vE '^(CMakeLists\.txt|version\.rc|README\.md|icon\.png|icon\.ico)$' || true)

              if [ -n "$changed_files" ]; then
                echo "Code changes detected (excluding ignored files):"
                echo "$changed_files"
                CODE_CHANGED=1
              else
                echo "No code changes detected (only ignored files changed or no changes)."
                CODE_CHANGED=0
              fi

              if [ "$CODE_CHANGED" -eq 1 ]; then
                # Bump PATCH, reset BUILD to 0 (e.g. 1.2.0.3 -> 1.2.1.0)
                PATCH=$((PATCH + 1))
                BUILD=0

                # Same rollover rules as before: PATCH>15 → MINOR+1, PATCH=0; MINOR>99 → MAJOR+1, MINOR=0
                if [ "$PATCH" -gt 15 ]; then
                  PATCH=0
                  MINOR=$((MINOR + 1))
                fi

                if [ "$MINOR" -gt 99 ]; then
                  MINOR=0
                  MAJOR=$((MAJOR + 1))
                fi
              else
                # No code changes: keep PATCH, bump BUILD (e.g. 1.2.0.3 -> 1.2.0.4)
                BUILD=$((BUILD + 1))
              fi

              new="v${MAJOR}.${MINOR}.${PATCH}.${BUILD}"
            fi

            echo "Manual dispatch -> new tag: $new"

            if [ -n "$REPO_PAT" ]; then
              AUTH_TOKEN="$REPO_PAT"
            else
              AUTH_TOKEN="$GITHUB_TOKEN"
            fi

            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git remote set-url origin https://${AUTH_TOKEN}@github.com/${REPO}.git
            git tag "$new"
            git push origin "$new"

            echo "new_version=$new" >> $GITHUB_OUTPUT
          else
            # Release event: just use the tag that triggered the workflow
            refname=${GITHUB_REF##*/}
            echo "Release event -> using tag: $refname"
            echo "new_version=$refname" >> $GITHUB_OUTPUT
          fi

  # =========================================================
  # WINDOWS BUILD (Manual Copy, uses 4-part version)
  # =========================================================
  build-windows:
    needs: prepare
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw81'
          install-deps: 'true'
          tools: 'tools_mingw,qt.tools.win64_mingw810'

      - name: Build and Package
        shell: bash
        env:
          QT_ROOT: ${{ env.Qt5_Dir }}
          MINGW_BIN: ${{ env.IQTA_TOOLS }}/mingw810_64/bin
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e

          # 1. Update version.rc from tag (vMAJOR.MINOR.PATCH.BUILD)
          VER_NO_V=${VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH BUILD <<< "$VER_NO_V"
          RC_NUM="${MAJOR},${MINOR},${PATCH},${BUILD}"
          RC_STR="${MAJOR}.${MINOR}.${PATCH}.${BUILD}"
          RC_FILE="version.rc"

          if [ -f "$RC_FILE" ]; then
            echo "Updating version.rc to $RC_STR..."
            sed -i -E "s/FILEVERSION[ \t]+[0-9,]+/FILEVERSION ${RC_NUM}/" "$RC_FILE"
            sed -i -E "s/PRODUCTVERSION[ \t]+[0-9,]+/PRODUCTVERSION ${RC_NUM}/" "$RC_FILE"
            sed -i -E "s/(\"FileVersion\",[ \t]*\")[0-9.]+(\".*)/\1${RC_STR}\2/" "$RC_FILE"
            sed -i -E "s/(\"ProductVersion\",[ \t]*\")[0-9.]+(\".*)/\1${RC_STR}\2/" "$RC_FILE"
          else
            echo "WARNING: version.rc not found."
          fi

          # 2. Build
          export PATH="$MINGW_BIN:$QT_ROOT/bin:$PATH"
          mkdir -p build
          cd build
          cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
          cmake --build .

          # 3. MANUAL DEPLOYMENT
          echo "Executing manual DLL deployment..."
          cp "$QT_ROOT/bin/Qt5Core.dll" .
          cp "$QT_ROOT/bin/Qt5Gui.dll" .
          cp "$QT_ROOT/bin/Qt5Widgets.dll" .
          cp "$QT_ROOT/bin/Qt5Network.dll" .
          cp "$QT_ROOT/bin/Qt5WebSockets.dll" .
          cp "$MINGW_BIN/libgcc_s_seh-1.dll" .
          cp "$MINGW_BIN/libstdc++-6.dll" .
          cp "$MINGW_BIN/libwinpthread-1.dll" .

          mkdir -p platforms
          cp "$QT_ROOT/plugins/platforms/qwindows.dll" platforms/

          # 4. Download OpenSSL
          curl -L -o libssl-1_1-x64.dll http://hienob.bargmy.ir/openssl/libssl-1_1-x64.dll
          curl -L -o libcrypto-1_1-x64.dll http://hienob.bargmy.ir/openssl/libcrypto-1_1-x64.dll

          # 5. Zip
          ZIP_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_Windows.zip"
          7z a "$ZIP_NAME" * -xr!*.obj -xr!*.cpp -xr!*.h -xr!Makefile -xr!CMakeFiles -xr!*_autogen

          echo "WIN_ASSET=build/$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Windows Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.WIN_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =========================================================
  # LINUX BUILD (uses icon.png 512x512 from repo root)
  # =========================================================
  build-linux:
    needs: prepare
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          install-deps: 'true'

      - name: Install Deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev cmake wget file

      - name: Build and Bundle
        env:
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e

          export PATH="${Qt5_Dir}/bin:$PATH"

          mkdir -p build
          cd build

          cmake .. -DCMAKE_BUILD_TYPE=Release
          cmake --build .

          # Prepare AppDir
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps/
          cp NoveoDesktop AppDir/usr/bin/

          # Icon: ONLY use icon.png from repo root (expected 512x512)
          if [ -f "../icon.png" ]; then
            echo "Using icon.png from repo root..."
            cp "../icon.png" AppDir/usr/share/icons/hicolor/512x512/apps/noveodesktop.png
          else
            echo "WARNING: icon.png not found in repo root, continuing without custom icon."
          fi

          # Desktop file with Icon name matching noveodesktop.png (without extension)
          cat > AppDir/usr/share/applications/NoveoDesktop.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=NoveoDesktop
          Exec=NoveoDesktop
          Icon=noveodesktop
          Categories=Utility;
          EOF

          # Package AppDir as tar.gz
          LINUX_TAR="NoveoDesktop_${VERSION}_${DATE}_x64_Linux.tar.gz"
          tar czf "$LINUX_TAR" AppDir

          echo "LINUX_ASSET=build/$LINUX_TAR" >> $GITHUB_ENV

      - name: Upload Linux Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.LINUX_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =========================================================
  # MACOS BUILD
  # =========================================================
  build-macos:
    needs: prepare
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare.outputs.new_version }}

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.15.2'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          install-deps: 'true'

      - name: Build and Bundle
        env:
          VERSION: ${{ needs.prepare.outputs.new_version }}
          DATE: ${{ needs.prepare.outputs.build_date }}
        run: |
          set -e

          export PATH="${Qt5_Dir}/bin:$PATH"

          mkdir -p build
          cd build

          cmake .. -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="${Qt5_Dir}" \
            -DCMAKE_OSX_ARCHITECTURES=x86_64

          cmake --build .

          APP_NAME="NoveoDesktop.app"

          mkdir -p "$APP_NAME/Contents/MacOS"
          mkdir -p "$APP_NAME/Contents/Resources"

          cp NoveoDesktop "$APP_NAME/Contents/MacOS/"

          if [ -f "../icon.icns" ]; then
            cp "../icon.icns" "$APP_NAME/Contents/Resources/"
          fi

          cat > "$APP_NAME/Contents/Info.plist" << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key>
            <string>NoveoDesktop</string>
            <key>CFBundleIdentifier</key>
            <string>com.hienob.noveodesktop</string>
            <key>CFBundleName</key>
            <string>NoveoDesktop</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleIconFile</key>
            <string>icon.icns</string>
          </dict>
          </plist>
          EOF

          macdeployqt "$APP_NAME" -dmg -verbose=1

          DMG_FILE=$(ls *.dmg 2>/dev/null | head -n 1 || true)
          if [ -n "$DMG_FILE" ]; then
            NEW_DMG="NoveoDesktop_${VERSION}_${DATE}_x64_MacOS.dmg"
            mv "$DMG_FILE" "$NEW_DMG"
            FINAL_ASSET="$NEW_DMG"
          else
            ZIP_NAME="NoveoDesktop_${VERSION}_${DATE}_x64_MacOS.zip"
            zip -r "$ZIP_NAME" "$APP_NAME"
            FINAL_ASSET="$ZIP_NAME"
          fi

          echo "MAC_ASSET=build/$FINAL_ASSET" >> $GITHUB_ENV

      - name: Upload MacOS Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.new_version }}
          files: ${{ env.MAC_ASSET }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
